# NT TaxOffice Node - AI Development Context

This file provides context for AI development assistants working on this project.

## Project Overview

**Name**: NT TaxOffice Node
**Type**: Full-stack appointment booking system for tax office services
**Stack**: Node.js, Express, MySQL, Vanilla JavaScript frontend
**Status**: Active development with comprehensive test suite

## Architecture

### Design Pattern

Service-oriented architecture with clear separation of concerns:

```
Client Request → Routes (HTTP) → Services (Business Logic) → Database
```

### Key Directories

- `routes/` - HTTP endpoint handlers (thin controllers)
- `services/` - Business logic and database operations
- `middleware/` - Express middleware (auth, error handling, rate limiting)
- `public/` - Static frontend files (HTML, CSS, JS)
- `tests/` - Comprehensive test suite (unit, integration, E2E)
- `utils/` - Utility functions (validation, sanitization, logging)
- `database/` - Database schema and initialization
- `docs/` - Documentation (API, guides, testing)

## Coding Conventions

### Style Guidelines

- **Async/await** preferred over callbacks
- **Error handling** - All async route handlers wrapped in `asyncHandler`
- **Input validation** - Use `utils/validation.js` functions
- **Input sanitization** - Use `utils/sanitization.js` before database storage
- **Logging** - Use `utils/logger.js` instead of `console.log`
- **Comments** - Explain WHY, not WHAT (code should be self-explanatory)

### Security Best Practices

- **CSP-compliant** - All JavaScript uses event delegation (no inline handlers)
- **Input validation** - Validate all user inputs
- **SQL injection prevention** - Use parameterized queries
- **XSS prevention** - Sanitize all user-generated content
- **Rate limiting** - Applied to all public endpoints
- **Session security** - HTTP-only, secure cookies in production

### Database Conventions

- **Connection pooling** - Use `getDb()` from `services/database.js`
- **Parameterized queries** - Always use `?` placeholders
- **Transactions** - Use for multi-step operations
- **Optimistic locking** - Use `version` column for concurrent updates

## Testing Conventions

### Test Organization

```
tests/
├── unit/           # Fast, isolated tests (mocked dependencies)
├── integration/    # API tests with real database
├── e2e/            # Playwright browser tests
└── helpers/        # Test utilities and builders
```

### Modern Test Utilities (IMPORTANT!)

When writing tests, always use these optimized utilities:

#### 1. Test Data Builders (Fluent API)

```javascript
const { AppointmentBuilder, AdminBuilder } = require('./helpers/builders');

// Use builders instead of hardcoded objects
const appointment = new AppointmentBuilder().onDate('2025-12-15').forTaxReturn().build();
```

#### 2. Database Seeders (10x faster than HTTP)

```javascript
const { seedAdminUser, seedAppointments } = require('./helpers/seeders');

// Use seeders instead of HTTP requests for test setup
const admin = await seedAdminUser({ username: 'admin' });
```

#### 3. Custom Jest Matchers

```javascript
// Use domain-specific matchers for clearer tests
expect(appointment).toBeValidAppointment();
expect(appointmentId).toExistInDatabase();
expect(response).toIndicateSuccess();
```

#### 4. Shared Connection Pool

```javascript
const { getTestDatabase } = require('./helpers/testDatabase');

// Use shared pool to eliminate redundant connections
beforeAll(async () => {
  await getTestDatabase();
});
```

#### 5. Transaction Isolation (10-20x faster)

```javascript
const { withTransaction } = require('./helpers/transactionHelper');

// Use transactions for fast test isolation
test('should create', async () => {
  await withTransaction(async (tx) => {
    // Test code here - automatically rolled back
  });
});
```

### Test Performance Guidelines

- **Use seeders** instead of HTTP for test setup (10x faster)
- **Use shared connection pool** to eliminate redundant connections
- **Use transaction isolation** for unit tests (10-20x faster than truncate)
- **Share admin sessions** across tests in same file (reduces bcrypt operations)
- **Performance monitoring** is enabled by default - check slow tests

### Test Commands

```bash
npm test                  # All tests (sequential, stable)
npm run test:parallel     # Fast parallel execution
npm run test:fast         # Fast unit tests
npm run test:admin        # Admin API tests only
npm run test:api          # Public API tests only
npm run test:coverage     # Generate coverage report
```

## Key Technical Decisions

### Why Session-Based Auth (not JWT)?

- Simpler implementation (no token refresh logic)
- Server-side control (instant invalidation)
- More secure for admin panel use case

### Why Email Queue System?

- Reliability (automatic retries on failure)
- Performance (non-blocking email sending)
- Monitoring (easy to identify failed emails)

### Why CSP-Compliant JavaScript?

- Security (prevents XSS attacks)
- Performance (fewer event listeners)
- Best practice (modern web standards)

### Why Transaction-Based Test Isolation?

- Speed (10-20x faster than truncating tables)
- Reliability (complete rollback)
- Safety (no test data leaks between tests)

## Database Schema

### Core Tables

1. **`admin_users`** - Admin authentication (bcrypt hashed passwords)
2. **`appointments`** - Appointment records with versioning (`version` column for optimistic locking)
3. **`availability_settings`** - Per-day working hours (7 rows, one per day)
4. **`blocked_dates`** - Specific dates when bookings are unavailable
5. **`email_queue`** - Queued emails with retry logic
6. **`security_audit_log`** - Security event tracking (logins, changes)

### Important Columns

- `appointments.version` - Used for optimistic locking (increment on update)
- `appointments.cancellation_token` - UUID for secure cancellation links
- `email_queue.retry_count` - Track failed email attempts (max 3)
- `availability_settings.is_working_day` - Boolean for working/non-working days

## Environment Variables

### Critical Variables

- `SESSION_SECRET` - Must be strong (64+ chars) in production
- `DB_HOST` - Use `mysql` for Docker, `localhost` for local dev
- `GMAIL_APP_PASSWORD` - Must be app-specific password (not regular password)
- `NODE_ENV` - Controls bcrypt rounds and rate limiting

### Test Environment

- Use `.env.test` for test configuration
- Lower bcrypt rounds (4 vs 10) for faster tests
- Separate test database to avoid data conflicts

## Common Pitfalls to Avoid

### Email Not Sending

- **Problem**: Using regular Gmail password instead of app-specific password
- **Solution**: Generate app-specific password at https://myaccount.google.com/apppasswords

### Database Connection Errors

- **Problem**: Wrong `DB_HOST` for Docker vs local
- **Solution**: `mysql` for Docker, `localhost` for local

### CSP Violations

- **Problem**: Adding inline `onclick` handlers
- **Solution**: Use event delegation pattern (see `public/js/admin/dashboard.js`)

### Slow Tests

- **Problem**: Using HTTP requests for test setup
- **Solution**: Use `seedAdminUser()` and other seeders for 10x faster setup

### Test Data Leaks

- **Problem**: Tests affecting each other
- **Solution**: Use `clearTestDatabase()` or transaction isolation

## Working with This Project

### Starting Development

1. Copy `.env.example` to `.env` and configure
2. Start database: `docker-compose up -d mysql`
3. Initialize database: `npm run db:init`
4. Start dev server: `npm run dev`

### Running Tests

1. Set up test environment: `npm run test:setup`
2. Run tests: `npm test` or `npm run test:parallel`
3. Check performance report for slow tests

### Making Changes

1. Read existing code patterns before writing new code
2. Follow the service-oriented architecture
3. Add tests for new features (use modern test utilities!)
4. Update documentation if changing APIs or behavior
5. Check security implications (CSP, XSS, SQL injection)

### Adding New Features

1. Start with service layer (business logic)
2. Add route handlers (thin controllers)
3. Create frontend interface (CSP-compliant JavaScript)
4. Write tests using modern test utilities
5. Update API documentation in `docs/api/endpoints.md`

## Documentation Structure

- **[README.md](README.md)** - Main project documentation
- **[tests/README.md](tests/README.md)** - Comprehensive testing guide
- **[docs/guides/testing.md](docs/guides/testing.md)** - Testing best practices
- **[docs/api/endpoints.md](docs/api/endpoints.md)** - Complete API reference
- **[docs/guides/deployment.md](docs/guides/deployment.md)** - Deployment guide
- **[docs/guides/admin-panel.md](docs/guides/admin-panel.md)** - Admin panel user guide

## Performance Benchmarks

Recent test optimizations achieved **30-40% faster execution**:

| Optimization           | Impact                  | Savings         |
| ---------------------- | ----------------------- | --------------- |
| Shared Connection Pool | 100+ fewer connections  | 1-2s            |
| Database Seeders       | 10x faster setup        | 10-20s          |
| Shared Admin Sessions  | 70+ → 5 bcrypt ops      | 10-14s          |
| Transaction Isolation  | 10-20x faster isolation | 5-10ms per test |
| Parallel Execution     | 4 workers vs sequential | 30-50% faster   |

## Greek Locale Support

The application supports Greek language and Greek locale:

- Test data builders generate Greek names using Faker.js
- Greek phone number format: `69XXXXXXXX` (mobile) or `2XXXXXXXXX` (landline)
- Greek email addresses available via `AdminBuilder.withGreekEmail()`
- Service types are in Greek (e.g., "Φορολογική Δήλωση")

## Git Workflow

### Commit Message Format

Use conventional commits for clarity:

```
feat: add appointment cancellation feature
fix: resolve database connection timeout
test: add performance monitoring for slow tests
docs: update testing guide with new utilities
perf: optimize test execution with connection pooling
```

### Branch Strategy

- `main` - Production-ready code
- `develop` - Integration branch for features
- `feature/*` - New features
- `fix/*` - Bug fixes

## Support and Resources

- **GitHub Repository**: https://github.com/itheCreator1/nt-taxoffice-node
- **CI/CD**: GitHub Actions (see `.github/workflows/test.yml`)
- **Test Status**: [![Test Suite](https://github.com/itheCreator1/nt-taxoffice-node/actions/workflows/test.yml/badge.svg)](https://github.com/itheCreator1/nt-taxoffice-node/actions/workflows/test.yml)

---

**Last Updated**: 2025-12-03
**Version**: 2.0.0 (with Phase 1-3 test optimizations)
